<html>
<head>
  <title>A Leaflet map!</title>
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css"/>
  <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>

  <script src= "http://d3js.org/topojson.v1.min.js"></script>

  <script type = "text/javascript" src= "d3/d3.min.js"></script>

  <script type = "text/javascript" src= "d3/d3.js"></script>
  <script type = "text/javascript" src = "d3-timeline/src/d3-timeline.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
  <script type = "text/javascript" src="http://d3js.org/topojson.v1.min.js"></script>
  <script type ="text/javascript" src="d3-slider/d3.slider.js" ></script>
  <script src="https://raw.github.com/fryn/html5slider/master/html5slider.js"></script>
  <link rel="stylesheet" href="d3-slider/d3.slider.css" />  
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

  <link rel="stylesheet" href= "timeline.css"/>
</head>

<body>
  <div class="page-header"><h1>Visual Analytics <small>Blues and The Great Migration</small></h1> </div>

   <div>
  <div class="panel panel-default">
    <div class="panel-body">
      <div id="timeline"></div>
             <div id="description">
          <div class="coloredDiv"></div>
          <div id="name"></div>
    </div>
    </div>
  </div>

  <div class="well well-lg">
     <input id="slider" type="range" min="1900" max="1970" value="1987" step="10" />
      <span id="range">1900</span>
  </div>

    <div id="map"></div>

    <script>

    // ==================STUFF FOR TIMELINE 
window.onload=function(){
    var $ = function(id) { return document.getElementById(id); };
    $('slider').oninput = function() { $('range').innerHTML = this.value; };
    $('slider').oninput();

    var data; // a global
    d3.json("dataProcessing/compiledTimeline.json", function(error, json) {
      if (error) return console.warn(error);
      data = json;
      timelineHover(data);
    });

    var width = 1200;
    var height = 100;

    function timelineHover(data) {

      var year = d3.time.format("%Y");
      var chart = d3.timeline()

      .width(width)         // Set timeline width
      .height(height)       // Set timeline height
      .stack()
      .beginning(-3471238780000)  // Set starting date for timeline
      .ending(80000000000)      // Set ending date for timeline
      .margin({left:70, right:30, top:0, bottom:0}) // Set margins
      .display("circle")      // Display points as circles
      .itemHeight(10)       // Set the diameter of the circles to 10px
      .hover(function (d, i, datum) { // Define what happens on hover

          // Removed unnecessary jQuery calls, replaced with D3 equivalent
        var div = d3.select('#description');  // Select the 'description' div
        div.select('.coloredDiv')       // Inside that, select the '.coloredDiv' element
          .style('background-color', d.color) //   and set its color to match the datapoint
          
        div.select('#name')   // Then select the 'name' div, and fill it with some text
        .text(year(new Date(d.starting_time)) + ": " + d.description);
      })
      .tickFormat({         // Set the formatting for the tickmarks:
      format: d3.time.format("%Y"),   // Select only the year portion of the date
      tickTime: d3.time.year,     // Display ticks in 1 year increments
      tickInterval: 5,        // Only display every 5th year
      tickSize: 5 });         // Draw 5px hashmarks at each tick

    // Build the timeline    
    var svg = d3.select("#timeline")
    .append("svg")
    .attr("width", width)
    .datum(data)
    .call(chart);

  // Rotate tick labels 90 degrees to improve legibility
  svg.selectAll(".tick").selectAll("text")
  .attr("y", 0)
  .attr("x", -20)
  .attr("dy", ".35em")
  .attr("transform", "rotate(-90)")
  .style("text-anchor", "right");
}
}


    // ===============STUFF FOR MAPS============

    var width = 960,
    height = 500;

    var color_domain = [500, 1000, 1500, 2000, 2500, 3000, 3500, 4000, 4500, 5000, 5500, 6000]
    var ext_color_domain = [0, 500, 1000, 1500, 2000, 2500, 3000, 3500, 4000, 4500, 5000, 5500, 6000]
    var legend_labels = ["&lt; 500", "500+", "1000+", "1500+", "2000+", "2500+", "3000+", "3500+", "4000+", "4500+", "5000+", "5500+", "6000+"]
    var color = d3.scale.threshold()
    .domain(color_domain)
    .range(["#dcdcdc", "#d0d6cd", "#bdc9be", "#aabdaf", "#97b0a0", "#84a491", "#719782", "#5e8b73", "#4b7e64", "#387255", "#256546", "#125937", "#004d28"]);

    var div = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

    var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)
    .style("margin", "10px auto");
    var path = d3.geo.path()


    queue()
    .defer(d3.json, "us.json")
    .defer(d3.csv, "allpopData.csv")
    .await(ready);

    var savedIds;
    function getIds(popToID){
    
      if(popToID === undefined){
        return savedIds;
      };

      if(popToID != undefined){
        savedIds = popToID;
      };

    };

    var savedUS
    function getUS(us){
      if(us === undefined){
        return savedUS;
      };

      if(us!= undefined){
        savedUS = us;
      };
    };

    function ready (error, us, data){
      var pairRateWithId = {};
      var pairNameWithId = {};

      data.forEach(function(d) {
        pairRateWithId[d.id] = [d.pop1900, d.pop1910, d.pop1920, d.pop1930, d.pop1940, d.pop1950, d.pop1960, d.pop1970];
        pairNameWithId[d.id] = d.county;
      });

      getIds(pairRateWithId);
      getUS(us);
      svg.append("g")
      .attr("class", "county")
      .selectAll("path")
      .data(topojson.feature(us, us.objects.counties).features)
      .enter().append("path")
      .attr("d", path)
      .style ( "fill" , function (d) {
        if (typeof pairRateWithId[d.id] !== 'undefined') {
          var colorOnDomain = color(pairRateWithId[d.id][0]);
          return colorOnDomain;
        };
      })
      .style("opacity", 0.8)
      .on("mouseover", function(d) {
        d3.select(this).transition().duration(300).style("opacity", 1);
        div.transition().duration(300)
        .style("opacity", 1)
        div.text(pairNameWithId[d.id] + " : " + pairRateWithId[d.id][0])
        .style("left", (d3.event.pageX) + "px")
        .style("top", (d3.event.pageY -30) + "px");
      })
      .on("mouseout", function() {
        d3.select(this)
        .transition().duration(300)
        .style("opacity", 0.8);
        div.transition().duration(300)
        .style("opacity", 0);
      })

    };

    var legend = svg.selectAll("g.legend")
    .data(ext_color_domain)
    .enter().append("g")
    .attr("class", "legend");

    var ls_w = 20, ls_h = 20;

    legend.append("rect")
    .attr("x", 20)
    .attr("y", function(d, i){ return height - (i*ls_h) - 2*ls_h;})
    .attr("width", ls_w)
    .attr("height", ls_h)
    .style("fill", function(d, i) { return color(d); })
    .style("opacity", 0.8);

    legend.append("text")
    .attr("x", 50)
    .attr("y", function(d, i){ return height - (i*ls_h) - ls_h - 4;})
    .text(function(d, i){ return legend_labels[i]; });

    d3.json("us.json", function(error, topology) {
      if (error) throw error;

      svg.selectAll("path")
      .data(topojson.feature(topology, topology.objects.counties).features)
      .enter().append("path")
      .attr("d", path);
   
        d3.selectAll("input").on("change", function change() {
          var value = this.value;


          d3.selectAll("path").style("fill", function(d) {
            var pairRateWithId = getIds();

            switch (value) {
              case "1900":
                if (typeof pairRateWithId[d.id] !== 'undefined') {
                  var colorOnDomain = color(pairRateWithId[d.id][0]);
                  console.log('pairRateWithId[d.id]', pairRateWithId[d.id])
                  console.log(colorOnDomain);
                  return colorOnDomain;
                 };
                break;
              case "1910":
                if (typeof pairRateWithId[d.id] !== 'undefined') {
                  var colorOnDomain = color(pairRateWithId[d.id][1]);
                  console.log('pairRateWithId[d.id]', pairRateWithId[d.id])
                  console.log(colorOnDomain);
                  return colorOnDomain;
                  };
                break;
              case "1920":
                  if (typeof pairRateWithId[d.id] !== 'undefined') {
                    var colorOnDomain = color(pairRateWithId[d.id][2]);
                    console.log('pairRateWithId[d.id]', pairRateWithId[d.id])
                    console.log(colorOnDomain);
                    return colorOnDomain;
                  };
                break;
              case "1930":
                if (typeof pairRateWithId[d.id] !== 'undefined') {
                  var colorOnDomain = color(pairRateWithId[d.id][3]);
                  console.log('pairRateWithId[d.id]', pairRateWithId[d.id])
                  console.log(colorOnDomain);
                  return colorOnDomain;
                };
                break;
              case "1940":
                if (typeof pairRateWithId[d.id] !== 'undefined') {
                  var colorOnDomain = color(pairRateWithId[d.id][4]);
                  console.log('pairRateWithId[d.id]', pairRateWithId[d.id])
                  console.log(colorOnDomain);
                  return colorOnDomain;
                };
                break;
              case "1950":
                if (typeof pairRateWithId[d.id] !== 'undefined') {
                  var colorOnDomain = color(pairRateWithId[d.id][5]);
                  console.log('pairRateWithId[d.id]', pairRateWithId[d.id])
                  console.log(colorOnDomain);
                  return colorOnDomain;
                };
                break;
              case "1960":
                if (typeof pairRateWithId[d.id] !== 'undefined') {
                  var colorOnDomain = color(pairRateWithId[d.id][6]);
                  console.log('pairRateWithId[d.id]', pairRateWithId[d.id])
                  console.log(colorOnDomain);
                  return colorOnDomain;
                };
                break;
              case "1970":
                if (typeof pairRateWithId[d.id] !== 'undefined') {
                  var colorOnDomain = color(pairRateWithId[d.id][7]);
                  console.log('pairRateWithId[d.id]', pairRateWithId[d.id])
                  console.log(colorOnDomain);
                  return colorOnDomain;
                };
                break;
            }
          });
        });
      });

    </script>
    </div>
  </body>
  </html>
